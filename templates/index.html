<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medical AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --primary-light: #eff6ff;
    --accent: #0ea5e9;
    --danger: #dc2626;
    --danger-light: #fef2f2;
    --warning: #d97706;
    --warning-light: #fffbeb;
    --success: #16a34a;
    --success-light: #f0fdf4;
    --info: #0369a1;
    --info-light: #e0f2fe;
    --text: #111827;
    --text-muted: #6b7280;
    --border: #e5e7eb;
    --bg: #f9fafb;
    --white: #ffffff;
    --radius: 10px;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --shadow-lg: 0 8px 40px rgba(0,0,0,0.14);
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: linear-gradient(135deg, #1e3a8a 0%, #0ea5e9 100%);
    min-height: 100vh;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 40px 20px;
  }

  .card {
    background: var(--white);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    width: 100%;
    max-width: 900px;
    padding: 48px 44px;
    position: relative;
  }

  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 36px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }

  .app-header .brand {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .app-header .brand-icon {
    width: 44px; height: 44px;
    background: var(--primary-light);
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
  }

  .app-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 22px;
    color: var(--text);
  }

  .app-header .subtitle {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .user-badge {
    display: flex;
    align-items: center;
    gap: 10px;
    background: var(--bg);
    padding: 8px 14px;
    border-radius: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .user-badge strong { color: var(--text); }

  /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--primary);
    color: var(--white);
  }
  .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }

  .btn-danger {
    background: var(--danger);
    color: var(--white);
    padding: 8px 14px;
    font-size: 13px;
  }
  .btn-danger:hover { background: #b91c1c; }

  .btn-secondary {
    background: var(--bg);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .btn-secondary:hover:not(:disabled) { background: var(--border); }

  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

  /* ‚îÄ‚îÄ Auth Section ‚îÄ‚îÄ */
  #authSection {
    max-width: 420px;
    margin: 0 auto;
  }

  .auth-header {
    text-align: center;
    margin-bottom: 36px;
  }

  .auth-header .brand-icon {
    width: 60px; height: 60px;
    background: var(--primary-light);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px;
    margin: 0 auto 16px;
  }

  .auth-header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 26px;
    color: var(--text);
  }

  .auth-header p {
    color: var(--text-muted);
    font-size: 13px;
    margin-top: 6px;
  }

  .auth-tabs {
    display: flex;
    border-bottom: 2px solid var(--border);
    margin-bottom: 24px;
  }

  .auth-tab {
    flex: 1;
    text-align: center;
    padding: 10px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }

  .auth-tab.active {
    color: var(--primary);
    border-bottom-color: var(--primary);
  }

  .auth-form { display: none; }
  .auth-form.active { display: block; }

  .field { margin-bottom: 14px; }

  .field label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 6px;
  }

  .field input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: 14px;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    transition: border-color 0.2s;
    background: var(--white);
  }

  .field input:focus {
    outline: none;
    border-color: var(--primary);
  }

  /* ‚îÄ‚îÄ App Section ‚îÄ‚îÄ */
  #appSection { display: none; }

  .section-label {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-muted);
    margin-bottom: 8px;
  }

  textarea {
    width: 100%;
    padding: 14px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--text);
    resize: vertical;
    min-height: 110px;
    transition: border-color 0.2s;
    background: var(--white);
  }

  textarea:focus { outline: none; border-color: var(--primary); }

  /* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
  .loading-bar {
    display: none;
    align-items: center;
    gap: 14px;
    padding: 16px;
    background: var(--primary-light);
    border-radius: var(--radius);
    margin-top: 16px;
    font-size: 14px;
    color: var(--primary);
    font-weight: 600;
  }

  .loading-bar.show { display: flex; }

  .spinner {
    width: 20px; height: 20px;
    border: 3px solid #bfdbfe;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
  .error-box {
    display: none;
    background: var(--danger-light);
    color: var(--danger);
    border: 1px solid #fecaca;
    padding: 13px 16px;
    border-radius: var(--radius);
    font-size: 14px;
    margin-top: 16px;
  }

  .error-box.show { display: block; }

  /* ‚îÄ‚îÄ Output ‚îÄ‚îÄ */
  #outputSection { display: none; margin-top: 36px; }
  #outputSection.show { display: block; }

  .output-divider {
    border: none;
    border-top: 1px solid var(--border);
    margin-bottom: 32px;
  }

  .output-heading {
    font-family: 'DM Serif Display', serif;
    font-size: 17px;
    color: var(--text);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .answer-box {
    background: var(--bg);
    padding: 20px;
    border-radius: var(--radius);
    line-height: 1.75;
    color: var(--text);
    font-size: 14px;
    white-space: pre-wrap;
  }

  /* ‚îÄ‚îÄ Context Cards ‚îÄ‚îÄ */
  .context-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 28px;
  }

  .ctx-card {
    background: var(--bg);
    border-left: 3px solid var(--primary);
    padding: 14px 16px;
    border-radius: var(--radius);
  }

  .ctx-card.warn { border-left-color: var(--danger); background: var(--danger-light); }

  .ctx-card .ctx-label {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .ctx-card.warn .ctx-label { color: var(--danger); }

  .ctx-card .ctx-value {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
  }

  .ctx-card.warn .ctx-value { color: var(--danger); }

  /* ‚îÄ‚îÄ Claims ‚îÄ‚îÄ */
  .claim-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 13px 16px;
    border-radius: var(--radius);
    background: var(--bg);
    margin-bottom: 10px;
  }

  .badge {
    flex-shrink: 0;
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 700;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .badge.recommendation { background: var(--success-light); color: var(--success); }
  .badge.monitoring     { background: var(--info-light);    color: var(--info); }
  .badge.risk           { background: var(--danger-light);  color: var(--danger); }
  .badge.warning        { background: var(--warning-light); color: var(--warning); }
  .badge.general        { background: var(--primary-light); color: var(--primary); }

  .claim-statement { font-size: 14px; color: #374151; line-height: 1.55; }

  /* ‚îÄ‚îÄ CONFIRMATION MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.4);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }

  .modal-card {
    background: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
    text-align: center;
    animation: fadeIn 0.3s ease;
  }
  
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .modal-icon {
    font-size: 32px;
    margin-bottom: 15px;
    display: block;
  }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 20px;
    color: var(--text);
    margin-bottom: 10px;
  }

  .modal-text {
    font-size: 14px;
    color: var(--text-muted);
    line-height: 1.5;
    margin-bottom: 24px;
  }

  .modal-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  .hidden { display: none !important; }
</style>
</head>

<body>
<div class="card">

  <div id="authSection">
    <div class="auth-header">
      <div class="brand-icon">üè•</div>
      <h1>Medical AI Assistant</h1>
      <p>Secure sign-in to access your medical assistant</p>
    </div>

    <div class="auth-tabs">
      <div class="auth-tab active" onclick="switchTab('login')">Sign In</div>
      <div class="auth-tab" onclick="switchTab('register')">Register</div>
    </div>

    <div id="loginForm" class="auth-form active">
      <div class="field">
        <label>Username</label>
        <input id="loginUsername" placeholder="Enter your username" autocomplete="username">
      </div>
      <div class="field">
        <label>Password</label>
        <input id="loginPassword" type="password" placeholder="Enter your password" autocomplete="current-password">
      </div>
      <div class="error-box" id="loginError"></div>
      <button class="btn btn-primary" style="width:100%; margin-top:6px; justify-content:center;" onclick="login()">Sign In</button>
    </div>

    <div id="registerForm" class="auth-form">
      <div class="field">
        <label>Username</label>
        <input id="regUsername" placeholder="Choose a username" autocomplete="username">
      </div>
      <div class="field">
        <label>Password</label>
        <input id="regPassword" type="password" placeholder="Choose a password" autocomplete="new-password">
      </div>
      <div class="error-box" id="registerError"></div>
      <button class="btn btn-primary" style="width:100%; margin-top:6px; justify-content:center;" onclick="register()">Create Account</button>
    </div>
  </div>

  <div id="appSection">

    <div class="app-header">
      <div class="brand">
        <div class="brand-icon">üè•</div>
        <div>
          <h1>Medical AI Assistant</h1>
          <div class="subtitle">AI-powered medical question answering</div>
        </div>
      </div>
      <div class="user-badge">
        Logged in as <strong id="loggedUser"></strong>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="section-label">Your Question</div>
    <textarea id="questionInput" placeholder="Ask your medical question‚Ä¶ e.g. 'I have heart failure and type 2 diabetes and now have a fever. What complications should I watch for?'"></textarea>

    <div style="margin-top:14px;">
      <button class="btn btn-primary" id="askBtn" onclick="askQuestion()">Submit Question</button>
    </div>

    <div class="loading-bar" id="loadingBar">
      <div class="spinner"></div>
      <span id="statusText">Processing your question‚Ä¶</span>
    </div>

    <div class="error-box" id="appError"></div>

    <div id="outputSection">
      <hr class="output-divider">

      <div id="contextSection"></div>

      <div class="output-heading">üí¨ Medical Assistant Response</div>
      <div class="answer-box" id="answerBox"></div>

      <div class="output-heading" style="margin-top:28px;">‚úÖ Extracted Medical Claims</div>
      <div id="claimsContainer"></div>
    </div>

  </div>
</div>

<div id="suggestionModal" class="modal-overlay">
  <div class="modal-card">
    <span class="modal-icon">ü©∫</span>
    <h3 class="modal-title">Update Health Profile?</h3>
    <p id="suggestionText" class="modal-text">The system found a new medical fact.</p>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="handleDecision(false)">No, thanks</button>
      <button class="btn btn-primary" onclick="handleDecision(true)">Yes, Update</button>
    </div>
  </div>
</div>

<script>
  let token = localStorage.getItem("jwt_token");
  let currentUser = null;
  
  // NEW: Queue to store multiple suggestions (e.g. Fever AND Aspirin)
  let suggestionQueue = [];
  let currentSuggestion = null;

  if (token) showApp();

  /* ‚îÄ‚îÄ Auth Tabs ‚îÄ‚îÄ */
  function switchTab(tab) {
    document.querySelectorAll('.auth-tab').forEach((t,i) => {
      t.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
    });
    document.getElementById('loginForm').classList.toggle('active', tab === 'login');
    document.getElementById('registerForm').classList.toggle('active', tab === 'register');
  }

  /* ‚îÄ‚îÄ JWT ‚îÄ‚îÄ */
  function parseJwt(t) {
    try { return JSON.parse(atob(t.split('.')[1])); } catch { return null; }
  }

  function showApp() {
    document.getElementById('authSection').classList.add('hidden');
    document.getElementById('appSection').style.display = 'block';
    if (!currentUser) {
      const payload = parseJwt(token);
      if (payload?.sub) { currentUser = payload.sub; }
      else { logout(); return; }
    }
    document.getElementById('loggedUser').textContent = currentUser;
  }

  function logout() {
    localStorage.removeItem("jwt_token");
    location.reload();
  }

  /* ‚îÄ‚îÄ Register ‚îÄ‚îÄ */
  async function register() {
    const errEl = document.getElementById('registerError');
    errEl.classList.remove('show');
    try {
      const res = await fetch("/api/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: regUsername.value, password: regPassword.value })
      });
      const data = await res.json();
      if (data.success) {
        switchTab('login');
        document.getElementById('loginUsername').value = regUsername.value;
      } else {
        errEl.textContent = data.error || "Registration failed";
        errEl.classList.add('show');
      }
    } catch (e) {
      errEl.textContent = "Network error: " + e.message;
      errEl.classList.add('show');
    }
  }

  /* ‚îÄ‚îÄ Login ‚îÄ‚îÄ */
  async function login() {
    const errEl = document.getElementById('loginError');
    errEl.classList.remove('show');
    try {
      const res = await fetch("/api/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: loginUsername.value, password: loginPassword.value })
      });
      const data = await res.json();
      if (data.success) {
        token = data.access_token;
        localStorage.setItem("jwt_token", token);
        currentUser = loginUsername.value;
        showApp();
      } else {
        errEl.textContent = data.error || "Login failed";
        errEl.classList.add('show');
      }
    } catch (e) {
      errEl.textContent = "Network error: " + e.message;
      errEl.classList.add('show');
    }
  }

  /* ‚îÄ‚îÄ Ask Question ‚îÄ‚îÄ */
  async function askQuestion() {
    const question = document.getElementById('questionInput').value.trim();
    const errEl = document.getElementById('appError');
    const loadingBar = document.getElementById('loadingBar');
    const outputSection = document.getElementById('outputSection');
    const askBtn = document.getElementById('askBtn');

    if (!question) { showAppError("Please enter a question."); return; }

    errEl.classList.remove('show');
    outputSection.classList.remove('show');
    loadingBar.classList.add('show');
    askBtn.disabled = true;
    document.getElementById('statusText').textContent = "üß† Processing your question‚Ä¶";

    try {
      const res = await fetch("/api/ask", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify({ question })
      });

      if (res.status === 401) {
        alert("Session expired. Please login again.");
        logout(); return;
      }

      const data = await res.json();

      if (!data.success) {
        showAppError(data.error || "Something went wrong");
        return;
      }

      // 1. Render Output
      renderContext(data.context);
      document.getElementById('answerBox').textContent = data.answer;
      renderClaims(data.claims);
      outputSection.classList.add('show');

      // 2. CHECK FOR AUTOPILOT SUGGESTIONS (List)
      if (data.suggestions && data.suggestions.length > 0) {
          suggestionQueue = data.suggestions; // Load queue
          processNextSuggestion(); // Start showing first one
      }

    } catch (e) {
      showAppError("Network error: " + e.message);
    } finally {
      loadingBar.classList.remove('show');
      askBtn.disabled = false;
    }
  }

  /* ‚îÄ‚îÄ Autograph Queue Logic ‚îÄ‚îÄ */
  function processNextSuggestion() {
      if (suggestionQueue.length === 0) {
          document.getElementById('suggestionModal').classList.remove('active');
          return;
      }
      
      currentSuggestion = suggestionQueue[0]; // Peek at first item
      document.getElementById('suggestionText').textContent = currentSuggestion.message;
      document.getElementById('suggestionModal').classList.add('active');
  }

  async function handleDecision(accepted) {
      if (!currentSuggestion) return;

      if (accepted) {
          const btn = document.querySelector('#suggestionModal .btn-primary');
          const originalText = btn.textContent;
          btn.textContent = "Updating...";
          btn.disabled = true;

          try {
              const res = await fetch("/api/confirm_update", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "Authorization": "Bearer " + token
                  },
                  body: JSON.stringify({
                      category: currentSuggestion.data.category,
                      entity: currentSuggestion.data.entity
                  })
              });
              
              const data = await res.json();
              if (data.success) {
                  // Success - move to next
              } else {
                  alert("‚ùå Update Failed: " + data.error);
              }
          } catch (e) {
              alert("Network Error");
          } finally {
              btn.textContent = originalText;
              btn.disabled = false;
          }
      }

      // Whether yes or no, remove current item and show next
      suggestionQueue.shift();
      processNextSuggestion();
  }

  /* ‚îÄ‚îÄ Render Context ‚îÄ‚îÄ */
  function renderContext(context) {
    const el = document.getElementById('contextSection');
    if (!context) { el.innerHTML = ''; return; }

    let cards = '';
    if (context.patient) {
        const p = context.patient; 
        const conditionsCount = p.conditions ? p.conditions.length : 0;
        const medsCount = p.medications ? p.medications.length : 0;
        
        cards += ctxCard("Patient ID", p.patient_id || p.id || "‚Äî");
        cards += ctxCard("Conditions", conditionsCount);
        cards += ctxCard("Medications", medsCount);
    }
    cards += ctxCard("Papers Found", context.papers_found ?? 0);
    cards += ctxCard("Wearables", context.wearables_available ? "Yes" : "No");

    if (context.drug_interactions && !context.drug_interactions.safe) {
      const n = context.drug_interactions.warnings?.length ?? 0;
      cards += ctxCard("‚ö†Ô∏è Drug Warnings", n, true);
    }

    el.innerHTML = `
      <div class="output-heading">üìã Context</div>
      <div class="context-grid">${cards}</div>
    `;
  }

  function ctxCard(label, value, warn = false) {
    return `<div class="ctx-card${warn ? ' warn' : ''}">
      <div class="ctx-label">${label}</div>
      <div class="ctx-value">${value}</div>
    </div>`;
  }

  /* ‚îÄ‚îÄ Render Claims ‚îÄ‚îÄ */
  function renderClaims(claims) {
    const el = document.getElementById('claimsContainer');
    if (!claims || !claims.length) {
      el.innerHTML = '<p style="color:var(--text-muted);font-size:14px;">No structured claims extracted.</p>';
      return;
    }
    el.innerHTML = claims.map(c => `
      <div class="claim-item">
        <span class="badge ${c.type || 'general'}">${c.type || 'general'}</span>
        <span class="claim-statement">${c.statement}</span>
      </div>
    `).join('');
  }

  function showAppError(msg) {
    const el = document.getElementById('appError');
    el.textContent = msg;
    el.classList.add('show');
  }

  /* ‚îÄ‚îÄ Keyboard shortcut ‚îÄ‚îÄ */
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && e.key === 'Enter') askQuestion();
  });
</script>
</body>
</html>
